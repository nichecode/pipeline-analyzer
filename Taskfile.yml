version: '3'

vars:
  APP_NAME: pipeline-analyzer
  VERSION:
    sh: git describe --tags --always --dirty 2>/dev/null || echo "dev"
  BUILD_TIME:
    sh: date -u '+%Y-%m-%d_%H:%M:%S'

env:
  CGO_ENABLED: 0

tasks:
  default:
    desc: Show available tasks and installation instructions
    cmds:
      - echo "ğŸš€ Pipeline Analyzer - Auto-Discovery Build Tool Analysis"
      - echo ""
      - echo "ğŸ“¦ INSTALLATION (Recommended):"
      - echo "   git clone https://github.com/nichecode/pipeline-analyzer.git"
      - echo "   cd pipeline-analyzer && task install"
      - echo ""
      - echo "ğŸ¯ USAGE:"
      - echo "   pipeline-analyzer                    (analyze current directory)"
      - echo "   pipeline-analyzer /path/to/repo     (analyze specific repository)"
      - echo ""
      - echo "ğŸ“‹ Available development tasks:"
      - task --list

  deps:
    desc: ğŸ“¦ Install dependencies
    cmds:
      - echo "ğŸ“¦ Installing dependencies..."
      - go mod tidy
      - go mod download
      - go mod verify

  build:
    desc: ğŸ”¨ Build pipeline-analyzer
    cmds:
      - echo "ğŸ”¨ Building {{.APP_NAME}}..."
      - go build -ldflags "-X main.version={{.VERSION}} -X main.buildTime={{.BUILD_TIME}}" -o {{.APP_NAME}} ./cmd/{{.APP_NAME}}
    sources:
      - cmd/pipeline-analyzer/main.go
      - internal/**/*.go
      - go.mod
      - go.sum
    generates:
      - "{{.APP_NAME}}"

  install:
    desc: ğŸ“² Install with go install (recommended)
    cmds:
      - echo "ğŸ“¦ Installing {{.APP_NAME}} with go install..."
      - go install ./cmd/{{.APP_NAME}}
      - echo "âœ… Installed {{.APP_NAME}} to $(go env GOPATH)/bin/"
      - echo "ğŸ’¡ Make sure $(go env GOPATH)/bin is in your PATH"
      - echo "ğŸ’¡ Now you can run '{{.APP_NAME}}' from anywhere!"

  install-dev:
    desc: ğŸ“² Install development build locally
    deps: [build]
    cmds:
      - mkdir -p ~/bin
      - cp {{.APP_NAME}} ~/bin/
      - echo "âœ… Installed development build to ~/bin"
      - echo "ğŸ’¡ Make sure ~/bin is in your PATH"

  run:
    desc: ğŸš€ Run pipeline-analyzer with default config
    deps: [build]
    cmds:
      - echo "ğŸš€ Running {{.APP_NAME}}..."
      - ./{{.APP_NAME}} {{.CLI_ARGS}}

  run-help:
    desc: ğŸš€ Show pipeline-analyzer help
    deps: [build]
    cmds:
      - ./{{.APP_NAME}} --help

  run-version:
    desc: ğŸš€ Show pipeline-analyzer version
    deps: [build]
    cmds:
      - ./{{.APP_NAME}} --version

  clean:
    desc: ğŸ§¹ Clean up build artifacts
    cmds:
      - echo "ğŸ§¹ Cleaning up..."
      - rm -f {{.APP_NAME}}
      - rm -rf dist/
      - rm -rf .discovery/
      - rm -rf circleci-analysis/
      - go clean

  test:
    desc: ğŸ§ª Run tests
    cmds:
      - echo "ğŸ§ª Running tests..."
      - go test -v ./...

  test-coverage:
    desc: ğŸ§ª Run tests with coverage
    cmds:
      - echo "ğŸ§ª Running tests with coverage..."
      - go test -v -coverprofile=coverage.out ./...
      - go tool cover -html=coverage.out -o coverage.html
      - echo "ğŸ“Š Coverage report generated coverage.html"

  fmt:
    desc: ğŸ¯ Format code
    cmds:
      - echo "ğŸ¯ Formatting code..."
      - go fmt ./...
      - goimports -w . 2>/dev/null || true

  lint:
    desc: ğŸ” Lint code
    cmds:
      - echo "ğŸ” Linting code..."
      - golangci-lint run || echo "ğŸ’¡ Install golangci-lint for better linting"

  vet:
    desc: ğŸ” Vet code
    cmds:
      - echo "ğŸ” Vetting code..."
      - go vet ./...

  release:
    desc: ğŸ“¦ Build release versions for multiple platforms
    cmds:
      - echo "ğŸ“¦ Building release versions..."
      - mkdir -p dist
      - task: release-build
        vars:
          GOOS: darwin
          GOARCH: amd64
          SUFFIX: darwin-amd64
      - task: release-build
        vars:
          GOOS: darwin
          GOARCH: arm64
          SUFFIX: darwin-arm64
      - task: release-build
        vars:
          GOOS: linux
          GOARCH: amd64
          SUFFIX: linux-amd64
      - task: release-build
        vars:
          GOOS: linux
          GOARCH: arm64
          SUFFIX: linux-arm64
      - task: release-build
        vars:
          GOOS: windows
          GOARCH: amd64
          SUFFIX: windows-amd64
          EXT: .exe
      - echo "âœ… Release builds completed in dist/"
      - ls -la dist/

  release-build:
    internal: true
    cmds:
      - GOOS={{.GOOS}} GOARCH={{.GOARCH}} go build -ldflags "-X main.version={{.VERSION}} -X main.buildTime={{.BUILD_TIME}}" -o dist/{{.APP_NAME}}-{{.SUFFIX}}{{.EXT}} ./cmd/{{.APP_NAME}}

  check:
    desc: ğŸ” Run all checks (fmt, vet, lint, test)
    cmds:
      - task: fmt
      - task: vet
      - task: lint
      - task: test

  setup:
    desc: ğŸ› ï¸ Initial setup for development
    cmds:
      - echo "ğŸ› ï¸ Setting up {{.APP_NAME}} development environment..."
      - task: deps
      - task: build
      - echo "âœ… Setup complete!"
      - echo ""
      - echo "ğŸ“¦ For end users, recommend:"
      - echo "   go install github.com/nichecode/pipeline-analyzer/cmd/pipeline-analyzer@latest"
      - echo ""
      - echo "ğŸ› ï¸ For development:"
      - echo "   task demo                    # See auto-discovery in action"
      - echo "   task install-dev             # Install development build"
      - echo "   task run-help                # Show help output"

  update:
    desc: ğŸ”„ Update dependencies
    cmds:
      - echo "ğŸ”„ Updating dependencies..."
      - go get -u ./...
      - go mod tidy
      - echo "âœ… Dependencies updated"

  demo:
    desc: ğŸ¬ Run auto-discovery demo on current repository
    deps: [build]
    cmds:
      - echo "ğŸ¬ Running auto-discovery demo..."
      - echo "ğŸ” This analyzes the current repository automatically"
      - echo "ğŸ’¡ End users would run pipeline-analyzer"
      - ./{{.APP_NAME}}
      - echo "ğŸ“ Demo complete! Check .discovery/pipeline-analyzer/"

  analyze-self:
    desc: ğŸ” Analyze this project with auto-discovery
    deps: [build]
    cmds:
      - echo "ğŸ” Running auto-discovery on this repository..."
      - ./{{.APP_NAME}}
      - echo "âœ… Self-analysis complete! Check .discovery/pipeline-analyzer/"

  test-examples:
    desc: ğŸ§ª Test analyzer on all examples
    deps: [build]
    cmds:
      - echo "ğŸ§ª Testing pipeline analyzer on examples..."
      - for example in examples/*/; do echo "Testing $$example"; ./{{.APP_NAME}} "$$example" || true; done
      - echo "âœ… Example testing complete!"

  demo-complex:
    desc: ğŸ¬ Demo analyzer on complex webapp example
    deps: [build]
    cmds:
      - echo "ğŸ¬ Running demo on complex webapp example..."
      - ./{{.APP_NAME}} examples/complex-webapp
      - echo "ğŸ“ Results available in examples/complex-webapp/.discovery/"
      - echo "ğŸŒ Open examples/complex-webapp/.discovery/pipeline-analyzer/index.html in browser"
      - echo "ğŸ“ Or view examples/complex-webapp/.discovery/pipeline-analyzer/README.md"

  open-example:
    desc: ğŸŒ Open complex webapp analysis in browser
    cmds:
      - open examples/complex-webapp/.discovery/pipeline-analyzer/index.html

  clean-examples:
    desc: ğŸ§¹ Clean up all example analysis results
    cmds:
      - echo "ğŸ§¹ Cleaning up example analysis results..."
      - rm -rf examples/*/.discovery/
      - echo "âœ… Example cleanup complete!"